includes:
    - vendor/phpstan/phpstan-strict-rules/rules.neon
    - vendor/phpstan/phpstan-deprecation-rules/rules.neon
    - vendor/phpstan/phpstan-phpunit/extension.neon
    - vendor/phpstan/phpstan-phpunit/rules.neon

parameters:
    level: 6
    paths:
        - src
        - config
    excludePaths:
        - src/helpers.php  # Global helper functions with dynamic signatures
    
    # Enable proper autoloading
    bootstrapFiles:
        - vendor/autoload.php
    
    # Improve analysis quality
    treatPhpDocTypesAsCertain: false
    # Deprecated in recent PHPStan; omit to avoid warnings
    checkGenericClassInNonGenericObjectType: true
    # Ignore patterns may be forward-looking; don't fail when unmatched
    reportUnmatchedIgnoredErrors: false
    ignoreErrors:
        - '#Instanceof between mixed and Monolog\\Handler\\AbstractProcessingHandler will always evaluate to false\.#'
        
        # EmailVerification.php issues with unknown class
        - '#Property Glueful\\Security\\EmailVerification::\$emailProvider has unknown class Glueful\\Extensions\\EmailNotification\\EmailNotificationProvider as its type\.#'
        - '#Instantiated class Glueful\\Extensions\\EmailNotification\\EmailNotificationProvider not found\.#'
        - '#Call to method [a-zA-Z0-9_]+\(\) on an unknown class Glueful\\Extensions\\EmailNotification\\EmailNotificationProvider\.#'

        # Framework utilities and helpers
        - '#Function config invoked with [0-9]+ parameter, 0-2 required\.#'
        - '#Function env invoked with [0-9]+ parameter, 1-2 required\.#'
        - '#Cannot call method [a-zA-Z0-9_]+\(\) on mixed\.#'
        
        # Database-related dynamic property access
        - '#Access to an undefined property PDO::\$[a-zA-Z0-9_]+\.#'
        - '#Call to an undefined method PDO::[a-zA-Z0-9_]+\(\)\.#'
        
        # Container and DI patterns
        - '#Method Glueful\\DI\\Container::get\(\) invoked with [0-9]+ parameter, 1 required\.#'
        - '#Parameter \#1 \$id of method Glueful\\DI\\Container::get\(\) expects string, .* given\.#'
        
        # Configuration array access patterns
        - '#Offset .* does not exist on array.*\.#'
        - '#Cannot access offset .* on mixed\.#'
        
        # Logging and error handling
        - '#Constructor of class Glueful\\Logging\\LogManager has an unused parameter \$logFile\.#'
        - '#Variable \$messageStr might not be defined\.#'
        
        # Development/unused methods (may be used by extensions or future features)
        - '#Method Glueful\\[a-zA-Z0-9\\_]+::[a-zA-Z0-9_]+\(\) is unused\.#'
        - '#Property .* is never read, only written\.#'
        
        # Cache and serialization
        - '#Method Glueful\\Security\\SecureSerializer::serialize\(\) should return string but returns string\|false\.#'
        - '#Method Glueful\\Security\\SecureSerializer::unserialize\(\) should return mixed but returns false\.#'
        
        # PSR-3 LoggerInterface compatibility - array type specifications
        - '#Method Glueful\\Logging\\LogManager::[a-zA-Z]+\(\) has parameter \$context with no value type specified in iterable type array\.#'

        # ORM patterns - these are standard Active Record patterns
        # Unsafe static is needed for model factories and inheritance
        - '#Unsafe usage of new static\(\)\.#'
        # Variable method calls are used for dynamic scopes and relationships
        - '#Variable method call on .*(Model|Builder).*\.#'
        # Variable method calls on mixed in ORM for nested eager loading
        - '#Variable method call on mixed\.#'
        # ORM relation method calls on class-string|object types
        - '#Cannot call method [a-zA-Z0-9_]+\(\) on class-string\|object\.#'
        # Generic type specifications in ORM are complex and handled at runtime
        - '#.*with generic class Glueful\\Database\\ORM\\.* does not specify its types.*#'
        - '#Method Glueful\\Database\\ORM\\.*return type with generic class .* does not specify its types.*#'
        - '#Method Glueful\\Database\\ORM\\.*should return static\(.*\).*but returns .*#'
        - '#Method Glueful\\Database\\ORM\\.*should return .*Collection<static\(.*\)> but returns.*#'
        - '#Method Glueful\\Database\\ORM\\Collection::.* should return .*Collection<TModel.*> but returns.*#'
        - '#Parameter .* of class Glueful\\Database\\ORM\\Collection constructor expects array<.*TModel.*>.*#'
        # ORM relations use variable property access for dynamic attributes
        - '#Variable property access on .*\.#'
        # is_object check on TModel is intentional for type safety
        - '#Call to function is_object\(\) with .* will always evaluate to true\.#'
        - '#Call to function is_string\(\) with string will always evaluate to true\.#'
        # Foreach variable reuse in recursive trait functions
        - '#Foreach overwrites \$class with its value variable\.#'
        # Short ternary in helper functions
        - '#Short ternary operator is not allowed.*#'

    banned_code:
        nodes:
            -
                type: Expr_ArrayDimFetch
                variable: '$GLOBALS'
                message: 'Use ApplicationContext instead of $GLOBALS'
        
